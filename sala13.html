<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Status da Sala 13 - HGF</title>
    <link rel="stylesheet" href="style.css">
    <style>
        html, body {
            height: auto;
            min-height: 100%;
            overflow-y: auto !important;
            margin: 0;
        }

        .content-status {
            padding-bottom: 120px;
        }

        /* Cores dos Status */
        .btn-status.ativo-ocupada { background-color: #ff0000 !important; color: white; }
        .btn-status.ativo-retirada { background-color: #ffdb58 !important; color: black; }
        .btn-status.ativo-limpeza { background-color: #ffa07a !important; color: white; }
        .btn-status.ativo-disponivel { background-color: #90ee90 !important; color: black; }
        .btn-status.ativo-indisponivel { background-color: #333 !important; color: white; border: 2px solid white; }
        
        /* Estilo para bot√£o desabilitado (Travado) */
        .btn-status:disabled {
            background-color: #e0e0e0 !important;
            color: #a0a0a0 !important;
            cursor: not-allowed;
            opacity: 0.6;
            border: 1px solid #ccc;
        }

        .painel-equipe {
            background: #f4f4f4;
            padding: 15px;
            border-radius: 12px;
            margin: 20px auto;
            max-width: 600px;
            border-left: 6px solid #4db1ad;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            text-align: left;
        }

        .status-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            width: 90%;
            max-width: 600px;
            margin: 0 auto;
        }

        .btn-status {
            min-height: 60px;
            font-size: 1rem;
            font-weight: bold;
            border-radius: 10px;
            border: none;
            cursor: pointer;
            transition: 0.2s;
        }
    </style>
</head>
<body class="page-status">

    <div id="mySidebar" class="modal-sidebar">
        <div class="sidebar-header">
            <span class="close-btn" onclick="toggleSidebar()">&times;</span>
        </div>
        <nav class="sidebar-links">
            <a href="controle.html">üè† Ir para Controle</a>
            <a href="relatorio.html">üìä Relat√≥rios</a>
        </nav>
    </div>

    <div id="overlay" class="overlay" onclick="toggleSidebar()"></div>

    <header class="header-status">
        <h1 class="titulo-pagina">Controle - Status da Sala 13</h1>
    </header>

    <div class="container-principal">
        <aside class="sidebar">
            <div class="icon-btn" onclick="toggleSidebar()">‚ò∞</div>
            <a id="link-config" href="configuracao.html?sala=13" style="text-decoration: none;">
                <div class="icon-btn">üìã</div>
            </a>
        </aside>

        <main class="content-status">
            <div class="logo-status-container">
                <img src="logo.png" alt="Logo HGF" class="logo-status">
            </div>

            <div id="info-equipe" class="painel-equipe" style="display: none;">
                <div style="font-size: 1.1rem; color: #333; margin-bottom: 5px;">üìç <strong>Opera√ß√£o Ativa</strong></div>
                <div><strong>Cirurgi√£o:</strong> <span id="nome-cirurgiao">---</span></div>
                <div><strong>Residente:</strong> <span id="nome-residente">---</span></div>
                <div><strong>Enfermeiro:</strong> <span id="nome-enfermeiro">---</span></div>
            </div>

            <div class="status-grid">
                <button id="btn-nova-cirurgia" class="btn-status" style="background-color: #4db1ad !important; color: white; grid-column: span 2;" onclick="iniciarNovaCirurgia()">
                    ‚ú® INICIAR NOVA CIRURGIA
                </button>

                <div style="grid-column: span 2; height: 10px;"></div>

                <button id="btn-disponivel" class="btn-status" onclick="definirStatus('disponivel')" disabled>1. Sala Pronta</button>
                <button id="btn-ocupada" class="btn-status" onclick="definirStatus('ocupada')" disabled>2. Sala em Cirurgia</button>
                <button id="btn-retirada" class="btn-status" onclick="definirStatus('retirada')" disabled>3. Retirada de Paciente</button>
                <button id="btn-limpeza" class="btn-status" onclick="definirStatus('limpeza')" disabled>4. Limpeza iniciada</button>

                <div style="grid-column: span 2; height: 10px;"></div>

                <button id="btn-encerrar" class="btn-status" style="background-color: #666 !important; color: white; grid-column: span 2;" onclick="encerrarAtividades()" disabled>
                    üèÅ FINALIZAR CICLO TOTAL
                </button>
            </div>

            <footer class="footer-status">
                <div class="data-atual" id="data-js">--/--/--</div>
                <div class="relogio" id="relogio-js">
                    <span class="icon-clock">üïí</span> 00:00
                </div>
            </footer>
        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getDatabase, ref, set, push, onValue, get, serverTimestamp, update } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyA_H-Ilb_bXEf uL6aNyLu3cvUBe9G_3RKY",
            authDomain: "salalivre-51288.firebaseapp.com",
            projectId: "salalivre-51288",
            storageBucket: "salalivre-51288.firebasestorage.app",
            messagingSenderId: "307835751640",
            appId: "1:307835751640:web:715796b42b827e7f9a0c7b"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        const h1Texto = document.querySelector('.titulo-pagina').textContent;
        const numSala = h1Texto.match(/\d+/)[0];
        document.getElementById('link-config').href = `configuracao.html?sala=${numSala}`;

        // --- FUN√á√ÉO DE TRAVA DE FLUXO ---
        window.gerenciarBotoes = function(statusAtual) {
            const botoes = {
                nova: document.getElementById('btn-nova-cirurgia'),
                pronta: document.getElementById('btn-disponivel'),
                ocupada: document.getElementById('btn-ocupada'),
                retirada: document.getElementById('btn-retirada'),
                limpeza: document.getElementById('btn-limpeza'),
                fim: document.getElementById('btn-encerrar')
            };

            // Desabilita tudo por padr√£o
            Object.values(botoes).forEach(b => b.disabled = true);

            // Regras do fluxo l√≥gico
            if (!statusAtual || statusAtual === 'indisponivel') {
                botoes.nova.disabled = false;
            } else if (statusAtual === 'preparacao') {
                botoes.pronta.disabled = false;
            } else if (statusAtual === 'disponivel') {
                botoes.ocupada.disabled = false;
            } else if (statusAtual === 'ocupada') {
                botoes.retirada.disabled = false;
            } else if (statusAtual === 'retirada') {
                botoes.limpeza.disabled = false;
            } else if (statusAtual === 'limpeza') {
                botoes.fim.disabled = false;
            }
        };

        window.toggleSidebar = function() {
            const sidebar = document.getElementById("mySidebar");
            const overlay = document.getElementById("overlay");
            sidebar.style.left = (sidebar.style.left === "0px") ? "-300px" : "0px";
            overlay.style.display = (overlay.style.display === "block") ? "none" : "block";
        };

        window.atualizarRelogio = function() {
            const agora = new Date();
            document.getElementById('data-js').textContent = agora.toLocaleDateString('pt-BR');
            document.getElementById('relogio-js').innerHTML = `<span class="icon-clock">üïí</span> ${agora.toLocaleTimeString('pt-BR', {hour: '2-digit', minute:'2-digit'})}`;
        };

        window.iniciarNovaCirurgia = async function() {
            const snapshot = await get(ref(db, `config_salas/sala${numSala}`));
            if (!snapshot.exists()) {
                alert("‚ö†Ô∏è Por favor, cadastre a equipe na prancheta antes de iniciar.");
                return;
            }
            const equipe = snapshot.val();
            const idUnico = "OP-" + numSala + "-" + Date.now();
            await set(ref(db, `operacao_ativa/sala${numSala}`), {
                idOperacao: idUnico, equipe: equipe, status: "preparacao", statusAnterior: "preparacao", ultimoTimestamp: Date.now()
            });
            set(ref(db, `status_atual/sala${numSala}`), { status: "preparacao", timestamp: serverTimestamp() });
        };

        window.definirStatus = async function(novoStatus) {
            const agora = Date.now();
            const dataString = new Date().toLocaleDateString('pt-BR');
            const operacaoRef = ref(db, `operacao_ativa/sala${numSala}`);
            const snap = await get(operacaoRef);
            const dados = snap.val();

            const diffMs = agora - dados.ultimoTimestamp;
            const duracao = `${Math.floor(diffMs / 60000)}min ${Math.floor((diffMs % 60000) / 1000)}s`;

            await set(push(ref(db, `historico/sala${numSala}`)), {
                idOperacao: dados.idOperacao, data: dataString, status: dados.statusAnterior,
                duracao: duracao, horarioInicio: new Date(dados.ultimoTimestamp).toLocaleTimeString(),
                ...dados.equipe
            });

            await update(operacaoRef, { status: novoStatus, statusAnterior: novoStatus, ultimoTimestamp: agora });
            set(ref(db, `status_atual/sala${numSala}`), { status: novoStatus, timestamp: serverTimestamp() });
        };

        window.encerrarAtividades = async function() {
            const operacaoRef = ref(db, `operacao_ativa/sala${numSala}`);
            const snap = await get(operacaoRef);
            const dados = snap.val();
            const agora = Date.now();
            const duracaoFinal = `${Math.floor((agora - dados.ultimoTimestamp)/60000)}min ${Math.floor(((agora - dados.ultimoTimestamp)%60000)/1000)}s`;
            
            await set(push(ref(db, `historico/sala${numSala}`)), {
                idOperacao: dados.idOperacao, data: new Date().toLocaleDateString('pt-BR'),
                status: dados.statusAnterior, duracao: duracaoFinal, horarioInicio: new Date(dados.ultimoTimestamp).toLocaleTimeString(),
                ...dados.equipe
            });

            await set(operacaoRef, null);
            set(ref(db, `status_atual/sala${numSala}`), { status: 'indisponivel', timestamp: serverTimestamp() });
            alert("üèÅ Ciclo encerrado com sucesso!");
        };

        window.onload = function() {
            atualizarRelogio();
            setInterval(atualizarRelogio, 1000);
            
            onValue(ref(db, `status_atual/sala${numSala}`), (snapshot) => {
                const status = snapshot.val() ? snapshot.val().status : 'indisponivel';
                
                // Aplica a trava de bot√µes baseada no status vindo do Firebase
                gerenciarBotoes(status);

                // Atualiza as cores visuais
                document.querySelectorAll('.btn-status').forEach(btn => btn.classList.remove('ativo-ocupada', 'ativo-retirada', 'ativo-limpeza', 'ativo-disponivel'));
                const mapaIds = { 'ocupada': 'btn-ocupada', 'retirada': 'btn-retirada', 'limpeza': 'btn-limpeza', 'disponivel': 'btn-disponivel' };
                if (mapaIds[status]) document.getElementById(mapaIds[status]).classList.add(`ativo-${status}`);
            });

            onValue(ref(db, `operacao_ativa/sala${numSala}`), (snapshot) => {
                const dados = snapshot.val();
                const painel = document.getElementById('info-equipe');
                if (dados && dados.equipe) {
                    painel.style.display = 'block';
                    document.getElementById('nome-cirurgiao').textContent = dados.equipe.cirurgiao;
                    document.getElementById('nome-residente').textContent = dados.equipe.residente || "N/A";
                    document.getElementById('nome-enfermeiro').textContent = dados.equipe.enfermeiro;
                } else { painel.style.display = 'none'; }
            });
        };
    </script>
</body>
</html>