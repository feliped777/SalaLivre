<!DOCTYPE html>
<html lang="pt-br">
<head>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Relat√≥rio de Efici√™ncia - HGF</title>
    <link rel="stylesheet" href="style.css">
    <style>
        body.page-status { overflow: hidden; display: flex; flex-direction: column; height: 100vh; }
        .container-relatorio { flex: 1; display: flex; flex-direction: column; align-items: center; padding: 20px; overflow: hidden; }
        .table-container { width: 98%; background: white; padding: 20px; border-radius: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin-top: 10px; overflow: auto; flex: 1; margin-bottom: 20px; }
        table { width: 100%; border-collapse: collapse; text-align: left; min-width: 1950px; }
        th { background-color: #4db1ad; color: white; padding: 12px; position: sticky; top: 0; z-index: 10; font-size: 0.9rem; }
        td { padding: 12px; border-bottom: 1px solid #eee; font-size: 0.85rem; }
        
        .linha-vazia { background-color: #f2f2f2 !important; height: 15px; }
        
        /* Destaque para o Tempo Total */
        .linha-resumo-total {
            background-color: #e8f4f3 !important;
            font-weight: bold;
            color: #2c7a77;
            border-bottom: 2px solid #4db1ad !important;
        }

        .area-botoes-relatorio { width: 100%; display: flex; justify-content: center; gap: 20px; padding-bottom: 20px; background-color: white; }
        .badge { padding: 5px 10px; border-radius: 10px; font-weight: bold; font-size: 0.75rem; text-transform: uppercase; color: white; }
        .badge.ativo-ocupada { background-color: #ff0000; }
        .badge.ativo-retirada { background-color: #ffdb58; color: black; }
        .badge.ativo-limpeza { background-color: #ffa07a; }
        .badge.ativo-disponivel { background-color: #90ee90; color: black; }
        
        .btn-exportar { background-color: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: bold; transition: 0.3s; }
        .btn-exportar:hover { background-color: #218838; }
    </style>
</head>
<body class="page-status">

    <header class="header-status">
        <h1 class="titulo-pagina">Relat√≥rio de Ocupa√ß√£o e Efici√™ncia</h1>
    </header>

    <div class="container-relatorio">
        <div class="logo-status-container" style="display: flex; justify-content: flex-end; width: 95%;">
            <img src="logo.png" alt="Logo HGF" class="logo-status">
        </div>

        <div class="table-container">
            <table id="tabela-dados">
                <thead>
                    <tr>
                        <th>Data</th>
                        <th>Sala</th>
                        <th>Status</th>
                        <th>In√≠cio</th>
                        <th>Dura√ß√£o</th>
                        <th>Cirurgi√£o</th>
                        <th>Resid. Cirurgia</th>
                        <th>Anestesista</th>
                        <th>Resid. Anestesia</th>
                        <th>Enfermeiro</th>
                        <th>Instrumentador(a)</th>
                        <th>Circulante(a)</th>
                    </tr>
                </thead>
                <tbody id="tabela-corpo"></tbody>
            </table>
        </div>

        <div class="area-botoes-relatorio">
            <button onclick="exportarExcel()" class="btn-exportar">üìä EXPORTAR EXCEL</button>
            <button onclick="limparHistorico()" class="btn-salvar-config" style="background-color: #ff4d4d;">LIMPAR TUDO</button>
            <a href="index.html" class="btn" style="text-decoration: none; display: flex; align-items: center; justify-content: center;">VOLTAR</a>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getDatabase, ref, onValue, set } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyA_H-Ilb_bXEf uL6aNyLu3cvUBe9G_3RKY",
            authDomain: "salalivre-51288.firebaseapp.com",
            projectId: "salalivre-51288",
            storageBucket: "salalivre-51288.firebasestorage.app",
            messagingSenderId: "307835751640",
            appId: "1:307835751640:web:715796b42b827e7f9a0c7b"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        const traduzirStatus = {
            'disponivel': 'Sala Pronta', 'ocupada': 'Em Cirurgia', 'retirada': 'Retirada Paciente',
            'limpeza': 'Limpeza Iniciada', 'preparacao': 'Prepara√ß√£o'
        };

        // Converte "5min 30s" em segundos para permitir c√°lculos
        function extrairSegundos(duracaoStr) {
            if (!duracaoStr) return 0;
            const partes = duracaoStr.match(/\d+/g);
            if (!partes) return 0;
            const min = parseInt(partes[0]) || 0;
            const seg = parseInt(partes[1]) || 0;
            return (min * 60) + seg;
        }

        function formatarTempoTotal(totalSegundos) {
            const min = Math.floor(totalSegundos / 60);
            const seg = totalSegundos % 60;
            return `${min}min ${seg}s`;
        }

        function carregarRelatorio() {
            const corpo = document.getElementById('tabela-corpo');
            const historicoRef = ref(db, 'historico');

            onValue(historicoRef, (snapshot) => {
                corpo.innerHTML = "";
                const data = snapshot.val();
                
                if (!data) {
                    corpo.innerHTML = "<tr><td colspan='12' style='text-align:center; padding: 50px;'>Nenhum dado registrado ainda.</td></tr>";
                    return;
                }

                let ultimaSalaProcessada = "";

                Object.keys(data).forEach(salaKey => {
                    // Pula linha entre salas diferentes
                    if (ultimaSalaProcessada !== "" && ultimaSalaProcessada !== salaKey) {
                        const trSeparadorSala = document.createElement('tr');
                        trSeparadorSala.innerHTML = "<td colspan='12' class='linha-vazia'></td>";
                        corpo.appendChild(trSeparadorSala);
                    }

                    const eventos = Object.values(data[salaKey]).reverse();
                    let ultimoIdOp = "";
                    let somaSegundos = 0;

                    eventos.forEach((evento, index) => {
                        // Se mudar o paciente na mesma sala, insere resumo e pula linha
                        if (ultimoIdOp !== "" && ultimoIdOp !== evento.idOperacao) {
                            const trTotal = document.createElement('tr');
                            trTotal.className = "linha-resumo-total";
                            trTotal.innerHTML = `<td colspan="4" style="text-align:right">TEMPO TOTAL DE USO DA SALA:</td><td>${formatarTempoTotal(somaSegundos)}</td><td colspan="7"></td>`;
                            corpo.appendChild(trTotal);
                            
                            const trVazia = document.createElement('tr');
                            trVazia.innerHTML = "<td colspan='12' class='linha-vazia'></td>";
                            corpo.appendChild(trVazia);
                            
                            somaSegundos = 0; 
                        }

                        const linha = document.createElement('tr');
                        linha.innerHTML = `
                            <td>${evento.data || '---'}</td>
                            <td><strong>${salaKey.replace('sala', 'Sala ')}</strong></td>
                            <td><span class="badge ativo-${evento.status}">${traduzirStatus[evento.status] || evento.status}</span></td>
                            <td>${evento.horarioInicio}</td>
                            <td>${evento.duracao}</td>
                            <td>${evento.cirurgiao || '---'}</td>
                            <td>${evento.residente || '---'}</td>
                            <td>${evento.anestesista || '---'}</td>
                            <td>${evento.res_anestesia || '---'}</td>
                            <td>${evento.enfermeiro || '---'}</td>
                            <td>${evento.instrumentador || '---'}</td>
                            <td>${evento.circulante || '---'}</td>
                        `;
                        corpo.appendChild(linha);
                        
                        somaSegundos += extrairSegundos(evento.duracao);
                        ultimoIdOp = evento.idOperacao;

                        // Adiciona resumo no final da lista da sala
                        if (index === eventos.length - 1) {
                            const trTotalFinal = document.createElement('tr');
                            trTotalFinal.className = "linha-resumo-total";
                            trTotalFinal.innerHTML = `<td colspan="4" style="text-align:right">TEMPO TOTAL DE USO DA SALA:</td><td>${formatarTempoTotal(somaSegundos)}</td><td colspan="7"></td>`;
                            corpo.appendChild(trTotalFinal);
                        }
                    });

                    ultimaSalaProcessada = salaKey;
                });
            });
        }

        window.exportarExcel = function() {
            const tabela = document.getElementById("tabela-dados");
            const wb = XLSX.utils.table_to_book(tabela, { sheet: "Relat√≥rio HGF" });
            const ws = wb.Sheets["Relat√≥rio HGF"];

            ws['!cols'] = [
                {wch: 12}, {wch: 10}, {wch: 20}, {wch: 15}, {wch: 15}, 
                {wch: 25}, {wch: 25}, {wch: 25}, {wch: 25}, 
                {wch: 25}, {wch: 25}, {wch: 25}
            ];

            XLSX.writeFile(wb, "Relatorio_Eficiencia_HGF.xlsx");
        };

        window.limparHistorico = function() {
            if (confirm("ATEN√á√ÉO: Deseja apagar permanentemente todo o hist√≥rico de todas as salas?")) {
                set(ref(db, 'historico'), null);
                set(ref(db, 'status_atual'), null);
                set(ref(db, 'operacao_ativa'), null);
                location.reload();
            }
        };

        window.onload = carregarRelatorio;
    </script>
</body>
</html>