<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Status da Sala - HGF</title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* Estilos para destacar o bot√£o ativo com a cor do status */
        .btn-status.ativo-ocupada { background-color: #ff0000 !important; color: white; }
        .btn-status.ativo-retirada { background-color: #ffdb58 !important; color: black; }
        .btn-status.ativo-limpeza { background-color: #ffa07a !important; color: white; }
        .btn-status.ativo-disponivel { background-color: #90ee90 !important; color: black; }
    </style>
</head>
<body class="page-status">

    <div id="mySidebar" class="modal-sidebar">
        <div class="sidebar-header">
            <span class="close-btn" onclick="toggleSidebar()">&times;</span>
        </div>
        <nav class="sidebar-links">
            <a href="controle.html">üè† Ir para Controle</a>
            <a href="visao.html">üëÅÔ∏è Ir para Vis√£o</a>
            <a href="index.html">In√≠cio</a>
            <a href="relatorio.html">üìä Relat√≥rios</a>
        </nav>
    </div>

    <div id="overlay" class="overlay" onclick="toggleSidebar()"></div>

    <header class="header-status">
        <h1 class="titulo-pagina">Controle - Status da Sala 1</h1>
    </header>

    <div class="container-principal">
        <aside class="sidebar">
            <div class="icon-btn" onclick="toggleSidebar()">‚ò∞</div>
            <a id="link-config" href="configuracao.html?sala=1" style="text-decoration: none;">
                <div class="icon-btn">üìã</div>
            </a>
        </aside>

        <main class="content-status">
            <div class="logo-status-container">
                <img src="logo.png" alt="Logo HGF" class="logo-status">
            </div>

            <div class="status-grid">
                <div class="status-grid">
    <button id="btn-ocupada" class="btn-status" onclick="definirStatus('ocupada')">Sala em Cirurgia</button>
    <button id="btn-retirada" class="btn-status" onclick="definirStatus('retirada')">Retirada de Paciente</button>
    <button id="btn-limpeza" class="btn-status" onclick="definirStatus('limpeza')">Limpeza iniciada</button>
    
    <div class="spacer"></div>
    
    <button id="btn-disponivel" class="btn-status central" onclick="definirStatus('disponivel')">Sala pronta para cirurgia</button>
    
    <button id="btn-encerrar" class="btn-status" style="background-color: #666 !important; color: white;" onclick="encerrarAtividades()">Encerrar Atividades (Pausar)</button>
</div></div>

            <footer class="footer-status">
                <div class="data-atual" id="data-js">--/--/--</div>
                <div class="relogio" id="relogio-js">
                    <span class="icon-clock">üïí</span> 00:00
                </div>
            </footer>
        </main>
    </div>

    <script type="module">
    // 1. IMPORTA√á√ÉO FIREBASE
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getDatabase, ref, set, push, onValue, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

    // Suas credenciais reais
    const firebaseConfig = {
        apiKey: "AIzaSyA_H-Ilb_bXEf uL6aNyLu3cvUBe9G_3RKY",
        authDomain: "salalivre-51288.firebaseapp.com",
        projectId: "salalivre-51288",
        storageBucket: "salalivre-51288.firebasestorage.app",
        messagingSenderId: "307835751640",
        appId: "1:307835751640:web:715796b42b827e7f9a0c7b"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // --- 2. IDENTIFICA√á√ÉO E NAVEGA√á√ÉO ---
    const h1Texto = document.querySelector('.titulo-pagina').textContent;
    const numSala = h1Texto.match(/\d+/)[0];
    document.getElementById('link-config').href = `configuracao.html?sala=${numSala}`;

    // --- 3. FUN√á√ïES DE INTERFACE (Globais) ---
    window.toggleSidebar = function() {
        const sidebar = document.getElementById("mySidebar");
        const overlay = document.getElementById("overlay");
        if (sidebar.style.left === "0px") {
            sidebar.style.left = "-300px";
            overlay.style.display = "none";
        } else {
            sidebar.style.left = "0px";
            overlay.style.display = "block";
        }
    };

    window.atualizarRelogio = function() {
        const agora = new Date();
        const dia = String(agora.getDate()).padStart(2, '0');
        const mes = String(agora.getMonth() + 1).padStart(2, '0');
        const ano = String(agora.getFullYear()).slice(-2);
        const horas = String(agora.getHours()).padStart(2, '0');
        const minutos = String(agora.getMinutes()).padStart(2, '0');
        document.getElementById('data-js').textContent = `${dia}/${mes}/${ano}`;
        document.getElementById('relogio-js').innerHTML = `<span class="icon-clock">üïí</span> ${horas}:${minutos}`;
    };

    window.atualizarCoresBotoes = function(statusAtivo) {
        const botoes = document.querySelectorAll('.btn-status');
        botoes.forEach(btn => {
            btn.classList.remove('ativo-ocupada', 'ativo-retirada', 'ativo-limpeza', 'ativo-disponivel', 'ativo-indisponivel');
        });
        const mapaIds = {
            'ocupada': 'btn-ocupada',
            'retirada': 'btn-retirada',
            'limpeza': 'btn-limpeza',
            'disponivel': 'btn-disponivel',
            'indisponivel': 'btn-encerrar'
        };
        const id = mapaIds[statusAtivo];
        if (id) document.getElementById(id).classList.add(`ativo-${statusAtivo}`);
    };

    // --- 4. L√ìGICA DE STATUS (FIREBASE + C√ÅLCULO) ---
    window.definirStatus = function(novoStatus) {
        const agora = new Date();
        const horarioFormatado = agora.toLocaleTimeString('pt-BR');

        // Refer√™ncia do hist√≥rico desta sala na nuvem
        const historicoRef = ref(db, `historico/sala${numSala}`);

        // 1. Primeiro, buscamos o √∫ltimo registro para fechar o tempo dele
        // (Isso agora deve ser feito no Firebase para sincronizar entre tablets)
        
        // 2. Atualiza o status atual na nuvem (para a Vis√£o ler)
        set(ref(db, `status_atual/sala${numSala}`), {
            status: novoStatus,
            horario: horarioFormatado,
            timestamp: serverTimestamp()
        });

        // 3. Adiciona novo registro ao hist√≥rico
        push(historicoRef, {
            status: novoStatus,
            horarioInicio: horarioFormatado,
            timestamp: serverTimestamp(),
            duracao: "Em curso..."
        });
    };

    window.encerrarAtividades = function() {
        set(ref(db, `status_atual/sala${numSala}`), {
            status: 'indisponivel',
            horario: new Date().toLocaleTimeString('pt-BR'),
            timestamp: serverTimestamp()
        });
        alert(`Atividades da Sala ${numSala} encerradas na nuvem.`);
    };

    // --- 5. INICIALIZA√á√ÉO E SINCRONIZA√á√ÉO EM TEMPO REAL ---
    window.onload = function() {
        atualizarRelogio();
        setInterval(atualizarRelogio, 1000);

        // Escuta o Firebase: Se o status mudar na nuvem, o bot√£o brilha no tablet
        onValue(ref(db, `status_atual/sala${numSala}`), (snapshot) => {
            const data = snapshot.val();
            if (data) {
                atualizarCoresBotoes(data.status);
            }
        });
    };
</script>
</body>
</html>